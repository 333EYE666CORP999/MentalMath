name: Build for Tests

on:
  pull_request:
    branches: [ "develop" ]

jobs:
  build:
    name: Build
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'

      - name: Prepare Environment
        run: |
          echo "ğŸ”§ Preparing Environment..."

          if [ "$(uname -m)" = "arm64" ]; then
            HOMEBREW_PREFIX="/opt/homebrew"
          else
            HOMEBREW_PREFIX="/usr/local"
          fi

          if ! command -v brew &> /dev/null; then
            echo "ğŸº Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          else
            echo "ğŸº Homebrew already installed. Updating packages..."
            brew upgrade --greedy-latest
          fi

          if [ ! -x "${HOMEBREW_PREFIX}/bin/swiftlint" ]; then
            echo "âš™ï¸ Installing SwiftLint..."
            brew install swiftlint
          else
            echo "âœ… SwiftLint already installed."
          fi

          if ! command -v jq &> /dev/null; then
            echo "âš™ï¸ Installing jq for JSON parsing..."
            brew install jq
          else
            echo "âœ… jq already installed."
          fi

          if ! command -v xcresultparser &> /dev/null; then
            echo "âš™ï¸ Installing xcresultparser..."
            brew install xcresultparser
          else
            echo "âœ… xcresultparser already installed."
          fi

      - name: SwiftLint
        run: |
          echo "ğŸ“ Running SwiftLint..."
          cd $GITHUB_WORKSPACE/Numerica-iOS

          swiftlint lint --config swiftlint.yml --reporter json > swiftlint_raw.json

          num_violations=$(jq '. | length' swiftlint_raw.json)
          threshold=20

          cat swiftlint_raw.json

          echo "ğŸ“Š Found $num_violations violations."

          if [ "$num_violations" -gt "$threshold" ]; then
            echo "âŒ Linting failed: $num_violations violations found (Threshold: $threshold)."
            exit 1
          else
            echo "âœ… Linting passed: $num_violations violations found (Threshold: $threshold)."
          fi

      - name: Build
        run: |
          echo "ğŸ”¨ Building Numerica Scheme..."
          cd $GITHUB_WORKSPACE/Numerica-iOS
          if [ "$(ls -A | grep -i \.xcworkspace\$)" ]; then
            filetype_parameter="workspace"
            file_to_build="$(ls -A | grep -i \.xcworkspace\$)"
          else
            filetype_parameter="project"
            file_to_build="$(ls -A | grep -i \.xcodeproj\$)"
          fi
          file_to_build=$(echo $file_to_build | awk '{$1=$1;print}')

          result_bundle_path="build-results/Numerica.xcresult"
          mkdir -p build-results

          set -o pipefail && xcodebuild build \
            -scheme "Numerica" \
            -"$filetype_parameter" "$file_to_build" \
            CODE_SIGNING_ALLOWED=NO \
            SWIFT_FLAGS="-Xfrontend -strict-concurrency=complete -swift-version 6" \
            -resultBundlePath "$result_bundle_path" \
            > build-results/build.log

          cat build-results/build.log

          # Parsing the build xcresult bundle using xcresultparser
          echo "ğŸ“„ Parsing build results from ${result_bundle_path}..."
          xcresultparser parse --path "$result_bundle_path" --output build-results/build-report.json
          cat build-results/build-report.json

          if [ $? -eq 0 ]; then
            echo "âœ… Build completed successfully."
          else
            echo "âŒ Build failed. Check the build log for more details."
            exit 1
          fi

  test:
    name: Test
    needs: build
    runs-on: macos-15

    strategy:
      matrix:
        scheme: [ "NumericaTests", "NumericaUITests" ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'

      - name: Run Tests
        run: |
          echo "ğŸ§ª Running Tests for Scheme: ${{ matrix.scheme }}..."
          cd $GITHUB_WORKSPACE/Numerica-iOS

          if [ "$(ls -A | grep -i \.xcworkspace\$)" ]; then
            filetype_parameter="workspace"
            file_to_build="$(ls -A | grep -i \.xcworkspace\$)"
          else
            filetype_parameter="project"
            file_to_build="$(ls -A | grep -i \.xcodeproj\$)"
          fi
          file_to_build=$(echo $file_to_build | awk '{$1=$1;print}')

          result_bundle_path="test-results/${{ matrix.scheme }}.xcresult"
          mkdir -p test-results

          # Running tests and redirecting logs to a file for easier inspection
          set -o pipefail && xcodebuild test \
            -scheme "${{ matrix.scheme }}" \
            -"$filetype_parameter" "$file_to_build" \
            -testPlan "${{ matrix.scheme }}" \
            -enableCodeCoverage YES \
            -parallel-testing-enabled YES \
            CODE_SIGNING_ALLOWED=NO \
            -resultBundlePath "$result_bundle_path" \
            > test-results/${{ matrix.scheme }}-test.log

          # Output the raw log for better visibility in CI
          cat test-results/${{ matrix.scheme }}-test.log

          # Parse xcresult using xcresultparser for better insight into test results
          echo "ğŸ“„ Parsing test results from ${result_bundle_path}..."
          xcresultparser parse --path "$result_bundle_path" --output test-results/${{ matrix.scheme }}-report.json
          cat test-results/${{ matrix.scheme }}-report.json

          if [ $? -eq 0 ]; then
            echo "âœ… All tests passed for scheme: ${{ matrix.scheme }}."
          else
            echo "âŒ Some tests failed for scheme: ${{ matrix.scheme }}. Check the log for details."
            exit 1
          fi
