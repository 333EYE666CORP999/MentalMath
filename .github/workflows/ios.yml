name: Build and Test

on:
  pull_request:
    branches: [ "develop" ]

jobs:
  build:
    name: Build Numerica
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Xcode Environment
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Prepare Environment
        run: |
          echo "ðŸ”§ Preparing Environment..."

          if [ "$(uname -m)" = "arm64" ]; then
            HOMEBREW_PREFIX="/opt/homebrew"
          else
            HOMEBREW_PREFIX="/usr/local"
          fi

          if ! command -v brew &> /dev/null; then
            echo "ðŸº Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          else
            echo "ðŸº Homebrew already installed. Updating packages..."
            brew upgrade --greedy-latest
          fi

          if [ ! -x "${HOMEBREW_PREFIX}/bin/swiftlint" ]; then
            echo "âš™ï¸ Installing SwiftLint..."
            brew install swiftlint
          else
            echo "âœ… SwiftLint already installed."
          fi

          if [ ! -x "${HOMEBREW_PREFIX}/bin/xcbeautify" ]; then
            echo "âš™ï¸ Installing xcbeautify..."
            brew install xcbeautify
          else
            echo "âœ… xcbeautify already installed."
          fi

      - name: Run SwiftLint
        run: |
          echo "ðŸ“ Running SwiftLint..."
          cd $GITHUB_WORKSPACE/Numerica-iOS

          # Run SwiftLint with JSON output and save to swiftlint.json
          swiftlint lint --config swiftlint.yml --reporter json > swiftlint.json

          # Install jq for parsing JSON if not available
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            brew install jq
          fi

          # Count the number of violations from the JSON output
          num_violations=$(jq '. | length' swiftlint.json)
          threshold=20

          echo "ðŸ“Š Found $num_violations violations."

          # Output SwiftLint results in a human-readable way
          cat swiftlint.json | jq

          # Decide to fail the build based on the threshold
          if [ "$num_violations" -gt "$threshold" ]; then
            echo "âŒ Linting failed: $num_violations violations found (Threshold: $threshold)."
            exit 1
          else
            echo "âœ… Linting passed: $num_violations violations found (Threshold: $threshold)."
          fi

      - name: Build Numerica Scheme
        run: |
          echo "ðŸ”¨ Building Numerica Scheme..."
          cd $GITHUB_WORKSPACE/Numerica-iOS
          if [ "$(ls -A | grep -i \.xcworkspace\$)" ]; then
            filetype_parameter="workspace"
            file_to_build="$(ls -A | grep -i \.xcworkspace\$)"
          else
            filetype_parameter="project"
            file_to_build="$(ls -A | grep -i \.xcodeproj\$)"
          fi
          file_to_build=$(echo $file_to_build | awk '{$1=$1;print}')
          set -o pipefail && xcodebuild build \
            -scheme "Numerica" \
            -"$filetype_parameter" "$file_to_build" \
            -destination "platform=iOS Simulator,name=iPhone 15 Pro Max,OS=18.1" \
            CODE_SIGNING_ALLOWED=NO \
            SWIFT_FLAGS="-Xfrontend -strict-concurrency=complete -swift-version 6" \
            | xcbeautify --is-ci --renderer github-actions
          if [ $? -eq 0 ]; then
            echo "âœ… Build completed successfully."
          else
            echo "âŒ Build failed."
            exit 1
          fi

  test:
    name: Run Tests in Parallel
    needs: build
    runs-on: macos-latest

    strategy:
      matrix:
        scheme: [NumericaTests, NumericaUITests]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Xcode Environment
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Select Random iPhone on iOS 18
        id: select_device
        run: |
          echo "ðŸ” Listing available simulators..."
          xcrun simctl list > simulators.txt

          # Start parsing the simulator list
          selected_device=""

          # Iterate through simulators.txt to find iOS 18 runtime section and devices
          while IFS= read -r line; do
            if echo "$line" | grep -q "iOS 18"; then
              ios_18_section="true"
            elif [[ "$line" =~ "--" ]]; then
              ios_18_section=""
            elif [[ -n "$ios_18_section" && "$line" =~ "iPhone" && "$line" =~ "available" ]]; then
              # Add the available iPhone devices under iOS 18.x section to the list
              available_devices+=("$line")
            fi
          done < simulators.txt

          # Check if there are any available devices
          if [ ${#available_devices[@]} -eq 0 ]; then
            echo "âŒ No available iPhone simulators running iOS 18 found."
            exit 1
          fi

          # Select a random device from the available list
          selected_device="${available_devices[$((RANDOM % ${#available_devices[@]}))]}"

          # Extract the relevant information from the selected line
          device_name=$(echo "$selected_device" | awk -F '[()]' '{print $1}' | xargs)
          device_id=$(echo "$selected_device" | grep -Eo '\([0-9A-F-]+\)' | tr -d '()')
          os_version="iOS 18" # This is inferred from the section header we selected from

          # Export the selected device information
          echo "Selected iPhone: $device_name, OS: $os_version, UDID: $device_id"
          echo "::set-output name=device::platform=iOS Simulator,UDID=$device_id"

      - name: Run Tests
        run: |
          echo "ðŸ§ª Running Tests for Scheme: ${{ matrix.scheme }}..."
          cd $GITHUB_WORKSPACE/Numerica-iOS
          if [ "$(ls -A | grep -i \.xcworkspace\$)" ]; then
            filetype_parameter="workspace"
            file_to_build="$(ls -A | grep -i \.xcworkspace\$)"
          else
            filetype_parameter="project"
            file_to_build="$(ls -A | grep -i \.xcodeproj\$)"
          fi
          file_to_build=$(echo $file_to_build | awk '{$1=$1;print}')
          set -o pipefail && xcodebuild test \
            -scheme "${{ matrix.scheme }}" \
            -"$filetype_parameter" "$file_to_build" \
            -destination "${{ steps.select_device.outputs.device }}" \
            -enableCodeCoverage YES \
            -parallel-testing-enabled YES \
            | tee unit_tests_${{ matrix.scheme }}.log | xcbeautify --is-ci --renderer github-actions
          if [ $? -eq 0 ]; then
            echo "âœ… All tests passed for scheme: ${{ matrix.scheme }}."
          else
            echo "âŒ Some tests failed for scheme: ${{ matrix.scheme }}. Check the log for details."
            exit 1
          fi
