name: Build and Test

on:
  pull_request:
    branches: [ "develop" ]

jobs:
  build:
    name: Build Numerica
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Xcode Environment
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Prepare Environment
        run: |
          echo "üîß Preparing Environment..."

          if [ "$(uname -m)" = "arm64" ]; then
            HOMEBREW_PREFIX="/opt/homebrew"
          else
            HOMEBREW_PREFIX="/usr/local"
          fi

          if ! command -v brew &> /dev/null; then
            echo "üç∫ Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          else
            echo "üç∫ Homebrew already installed. Updating packages..."
            brew upgrade --greedy-latest
          fi

          if [ ! -x "${HOMEBREW_PREFIX}/bin/swiftlint" ]; then
            echo "‚öôÔ∏è Installing SwiftLint..."
            brew install swiftlint
          else
            echo "‚úÖ SwiftLint already installed."
          fi

          if [ ! -x "${HOMEBREW_PREFIX}/bin/xcbeautify" ]; then
            echo "‚öôÔ∏è Installing xcbeautify..."
            brew install xcbeautify
          else
            echo "‚úÖ xcbeautify already installed."
          fi

          if ! command -v jq &> /dev/null; then
            echo "‚öôÔ∏è Installing jq for JSON parsing..."
            brew install jq
          else
            echo "‚úÖ jq already installed."
          fi

      - name: Run SwiftLint
        run: |
          echo "üìù Running SwiftLint..."
          cd $GITHUB_WORKSPACE/Numerica-iOS

          swiftlint lint --config swiftlint.yml --reporter json > swiftlint_raw.json

          num_violations=$(jq '. | length' swiftlint_raw.json)
          threshold=20

          echo "üìä Found $num_violations violations."

          cat swiftlint_raw.json

          if [ "$num_violations" -gt "$threshold" ]; then
            echo "‚ùå Linting failed: $num_violations violations found (Threshold: $threshold)."
            exit 1
          else
            echo "‚úÖ Linting passed: $num_violations violations found (Threshold: $threshold)."
          fi

      - name: Build Numerica Scheme
        run: |
          echo "üî® Building Numerica Scheme..."
          cd $GITHUB_WORKSPACE/Numerica-iOS
          if [ "$(ls -A | grep -i \.xcworkspace\$)" ]; then
            filetype_parameter="workspace"
            file_to_build="$(ls -A | grep -i \.xcworkspace\$)"
          else
            filetype_parameter="project"
            file_to_build="$(ls -A | grep -i \.xcodeproj\$)"
          fi
          file_to_build=$(echo $file_to_build | awk '{$1=$1;print}')
          set -o pipefail && xcodebuild build \
            -scheme "Numerica" \
            -"$filetype_parameter" "$file_to_build" \
            CODE_SIGNING_ALLOWED=NO \
            SWIFT_FLAGS="-Xfrontend -strict-concurrency=complete -swift-version 6" \
            | xcbeautify --is-ci --renderer github-actions
          if [ $? -eq 0 ]; then
            echo "‚úÖ Build completed successfully."
          else
            echo "‚ùå Build failed."
            exit 1
          fi

  test:
    name: Run Tests for All Schemes
    needs: build
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Xcode Environment
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Retrieve Schemes
        id: retrieve_schemes
        run: |
          echo "üîç Retrieving available schemes..."
          cd $GITHUB_WORKSPACE/Numerica-iOS

          if [ "$(ls -A | grep -i \.xcworkspace\$)" ]; then
            filetype_parameter="workspace"
            file_to_build="$(ls -A | grep -i \.xcworkspace\$)"
          else
            filetype_parameter="project"
            file_to_build="$(ls -A | grep -i \.xcodeproj\$)"
          fi
          file_to_build=$(echo $file_to_build | awk '{$1=$1;print}')

          # List schemes
          schemes=$(xcodebuild -list -$filetype_parameter "$file_to_build" -json | jq -r '.project.schemes[]')
          echo "üìÑ Available schemes: $schemes"

          # Save schemes to output
          echo "::set-output name=schemes::$schemes"

      - name: Run Tests for Each Scheme
        run: |
          echo "üß™ Running Tests for All Schemes..."
          cd $GITHUB_WORKSPACE/Numerica-iOS

          if [ "$(ls -A | grep -i \.xcworkspace\$)" ]; then
            filetype_parameter="workspace"
            file_to_build="$(ls -A | grep -i \.xcworkspace\$)"
          else
            filetype_parameter="project"
            file_to_build="$(ls -A | grep -i \.xcodeproj\$)"
          fi
          file_to_build=$(echo $file_to_build | awk '{$1=$1;print}')

          # Loop over all schemes
          for scheme in ${{ steps.retrieve_schemes.outputs.schemes }}; do
            echo "üß™ Running tests for scheme: $scheme"
            set -o pipefail && xcodebuild test \
              -scheme "$scheme" \
              -"$filetype_parameter" "$file_to_build" \
              -enableCodeCoverage YES \
              -parallel-testing-enabled YES \
              CODE_SIGNING_ALLOWED=NO \
              | xcbeautify --is-ci --renderer github-actions

            if [ $? -eq 0 ]; then
